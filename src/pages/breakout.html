<!DOCTYPE html>
<html>
<head>
  <title>GMod Multiplayer Breakout</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Press Start 2P', cursive;
      color: #FFFFFF;
      user-select: none; /* Prevent text selection */
      overflow: hidden;
    }
    #gameCanvas {
      background: #000;
      border: 4px solid #FFF;
      image-rendering: pixelated;
    }
    #info {
      margin: 10px 0;
      font-size: 14px;
      text-align: center;
    }
    .closeBtn {
      position: absolute;
      top: 10px; 
      right: 10px;
      background: #CC0000;
      color: #FFFFFF;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 12px;
    }
    .closeBtn:hover {
      background: #AA0000;
    }
  </style>
</head>
<body>
  <!-- Optional "Close" button that calls GMod to close the arcade -->
  <button class="closeBtn" onclick="window.gmod?.closeArcade()">Close</button>

  <canvas id="gameCanvas" width="640" height="480"></canvas>
  <div id="info">Score: <span id="scoreValue">0</span></div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreValue = document.getElementById('scoreValue');

    // The "gameState" is provided by GMod every tick:
    //   {
    //     ball: { x, y, radius },
    //     paddle: { x, y, width, height },
    //     bricks: [ { x, y, width, height, status }, ... ],
    //     score: number,
    //     gameActive: bool
    //   }

    // We only draw based on the state from the server. This ensures everyone sees the same game.
    window.updateFromLua = function(gameState) {
      if (!gameState) return;

      // Clear
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw bricks
      for (let i = 0; i < gameState.bricks.length; i++) {
        const b = gameState.bricks[i];
        if (b.status === 1) {
          ctx.fillStyle = '#FFCC00';
          ctx.fillRect(b.x, b.y, b.width, b.height);
        }
      }

      // Draw paddle
      ctx.fillStyle = '#00FF00';
      ctx.fillRect(gameState.paddle.x, gameState.paddle.y,
                   gameState.paddle.width, gameState.paddle.height);

      // Draw ball
      ctx.fillStyle = '#FFFFFF';
      ctx.beginPath();
      ctx.arc(gameState.ball.x, gameState.ball.y,
              gameState.ball.radius, 0, Math.PI*2);
      ctx.fill();

      // Update score display
      scoreValue.textContent = gameState.score;
    };

    // The controlling player will capture keyboard input and call:
    //   window.gmod.arcadeInput("moveLeft"), "moveRight", "launchBall"
    // But we want to let GMod decide if we are actually the controller or not.
    // In GMod, we set `Panel:SetKeyboardInputEnabled(true)` only for the controller.
    // So let's handle keydown here:
    document.addEventListener('keydown', (e) => {
      if (!window.gmod) return; // in case not in GMod
      switch(e.code) {
        case 'ArrowLeft':
          window.gmod.arcadeInput('moveLeft');
          break;
        case 'ArrowRight':
          window.gmod.arcadeInput('moveRight');
          break;
        case 'Space':
          window.gmod.arcadeInput('launchBall');
          break;
        default:
          break;
      }
    });

    // Because we might want "continuous" movement while key is held,
    // we can also handle keyup or rely on server to keep receiving "moveLeft" every tick from GMod.
    // But for simplicity, let's do repeated keydown events in GModâ€™s code if needed.

    // We'll also define a "closeArcade" function that the closeBtn uses:
    window.gmod = window.gmod || {};
    window.gmod.closeArcade = function() {
      // If we are in GMod, this calls the net message to close
      if (typeof gmod !== 'undefined' && gmod.closeArcade) {
        gmod.closeArcade();
      }
    };
  </script>
</body>
</html>
